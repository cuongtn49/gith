<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="css/test2.css">
    <link rel="stylesheet" href="css/qsStatus.css">
</head>
<style>
    /* Căn chỉnh chung cho toàn bộ form */
    #multiple-choice-format form {
        display: flex;
        flex-direction: column;
        /* gap: 15px; */
        font-family: Arial, sans-serif;
        /* max-width: 600px; */
        /* margin: 20px auto; */
    }


    /* Căn chỉnh cho các ô chọn (radio buttons) */
    input[type="radio"] {
        display: none;
        /* Ẩn nút radio gốc để thiết kế tùy chỉnh */
    }

    /* Phong cách cho nhãn của mỗi lựa chọn */
    /* label {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    border: 2px solid #ccc;
    border-radius: 8px;
    font-size: 16px;
    background-color: #f9f9f9;
    cursor: pointer;
    transition: background-color 0.3s ease, border-color 0.3s ease;
} */

    /* Hiệu ứng khi rê chuột vào nhãn */
    label:hover {
        background-color: #e0f7fa;
        border-color: #00796b;
    }

    /* Khi một lựa chọn được chọn */
    #multiple-choice-format input[type="radio"]:checked+label {
        /* background-color: #00796b; */
        /* border-color: #004d40; */
        color: red;
        /* font-weight: bold; */
    }

    #true-false-format input[type="radio"]:checked+label {
        color: red;
    }

    #true-false-format form {
        display: flex;
        flex-direction: column;
        gap: 10px;
        font-family: Arial, sans-serif;
    }

    .he {
        background: rgba(0, 255, 0, 0.1);
    }

    .answer-fill-world {
        margin-bottom: 10px;
        font-size: 16px;
        font-weight: bold;
        color: #4CAF50;
        background-color: #f9f9f9;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        text-align: left;
    }

    #right {
        position: fixed;
        ;
        top: 20px;
        width: 180px;
        margin-left: 10px;
        padding: 25px;
        border: none;
        border-radius: 10px;
        background-color: #ffffff;
        /* box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); */
        box-shadow: 0 2px 2px rgba(0, 0, 0, 0.2);
        text-align: center;
        height: fit-content;
    }

    #mark-test {
        font-size: 28px;
        font-weight: bold;
        color: #27ae60;
        background-color: #ecf9f1;
        padding: 15px;
        border-radius: 10px;
        box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }

    #countdown {
        font-size: 16px;
        font-weight: 600;
        color: #e74c3c;
        background-color: #ffe6e6;
        padding: 10px;
        border-radius: 10px;
        box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    #number-mark {
        font-size: 28px;
        color: black;
        font-weight: 600;
    }
</style>

<body>
    <div id="layout-test-format" style="display: none;">
        <div id="left">
            <div id="test-format">

                <div id="multiple-choice-format">
                    <div class="title-question">CÂU HỎI TRẮC NGHIỆM</div>
                    <!-- <div id="choice-multiple-choice-format"></div> -->
                    <!-- <div class="question-multiple-choice-format">QUESTION</div>
                    <div id="choice1-multiple-choice-format">A</div>
                    <div id="choice2-multiple-choice-format">B</div>
                    <div id="choice3-multiple-choice-format">C</div>
                    <div id="choice4-multiple-choice-format">D</div> -->
                </div>
                <div id="fill-word-format">
                    <div class="title-question">CÂU HỎI ĐIỀN ĐÁP ÁN</div>
                    <!-- <div class="question-fill-word-format">QUESTION</div>
                    <input type="text" id="answer-fill-word"> -->
                </div>
                <div id="true-false-format">
                    <div class="title-question">CÂU HỎI ĐÚNG/SAI</div>
                    <!-- <div class="question-true-false-format">QUESTION</div>
                    <input type="radio" name="question-true-false" id="select-true">
                    <label for="select-true">Đúng</label>
                    <input type="radio" name="question-true-false" id="select-false">
                    <label for="select-false">Sai</label> -->
                </div>
                <button id="submit-test">SUBMIT</button>
            </div>
        </div>
        <div id="right">
            <div id="mark-test" style="display: none;"></div>
            <p id="countdown"></p>
            <p id="number-mark" style="display: none;"></p>
            <!-- <div class="question-status">
                <h3>Trạng thái câu hỏi</h3>
                <div class="status-list">
                  <a href="#true-false-format"><div class="status-item not-answered">1</div></a>
                  <div class="status-item answered">2</div>
                  <div class="status-item current">3</div>
                  <div class="status-item not-answered">4</div>

                </div>
              </div> -->
        </div>

    </div>
    <img src="" alt="" style="margin-bottom: 10px;">
    <script>
        var flashcards = JSON.parse(localStorage.getItem("data")) || [];
        var mark = 0;
        var numberQuestion = 0;
        if (localStorage.getItem("test-structure")) {
            document.getElementById("layout-test-format").style.display = "block";
            var testStructure = JSON.parse(localStorage.getItem("test-structure"));
            console.log(testStructure);
            console.log(testStructure.multipleChoice);
            if (testStructure.multipleChoice.toString() === "true") {
                numberQuestion += parseInt(testStructure.number);
                var multipleChoice = multipleChoiceQuestion(flashcards, testStructure.number);
                exportMultipleChoiceQuestion(multipleChoice);
            } else {
                document.getElementById("multiple-choice-format").style.display = "none";
            }

            if (testStructure.fillWord.toString() === "true") {
                numberQuestion += parseInt(testStructure.number);
                var format = "answer";
                if (testStructure.question.toString() === "true") {
                    format = "question";
                } else {
                    format = "answer";
                }
                var fillWord = fillWordQuestion(flashcards, testStructure.number, format);
                exportFillWordQuestion(fillWord);
            } else {
                document.getElementById("fill-word-format").style.display = "none";
            }

            if (testStructure.trueFalse.toString() === "true") {
                numberQuestion += parseInt(testStructure.number);
                var trueFalse = trueFalseQuestion(flashcards, testStructure.number);
                exportTrueFalseQuestion(trueFalse);
            } else {
                document.getElementById("true-false-format").style.display = "none";
            }

        } else {
            document.getElementById("layout-test-format").style.display = "none";
            testStructure = { multipleChoice: false, fillWord: false, trueFalse: false, question: false, answer: false, number: 0, time: 0 };
            window.location.href = "SetTest.html";
        }
        let timeLeft = 0;
        let interval;
        if (testStructure) timeLeft = testStructure.time * 60;
        const countdownElement = document.getElementById("countdown");
        if (timeLeft > 0) {
            interval = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60; 
                countdownElement.textContent = `Thời gian: ${minutes}:${seconds < 10 ? "0" + seconds : seconds}`;
                timeLeft--;

                if (timeLeft < 0) {
                    clearInterval(interval); // Dừng đếm ngược
                    submit();
                    console.log("Form đã được submit tự động.");
                }
            }, 1000);
        }

        document.getElementById("submit-test").addEventListener("click", () => {
            mark = 0;
            const isConfirmed = confirm("Xác nhận nộp bài");
            if (isConfirmed) {
                if (testStructure.multipleChoice.toString() === "true") submitMultipleChoice(multipleChoice);
                if (testStructure.fillWord.toString() === "true") submitFillWord(fillWord);
                if (testStructure.trueFalse.toString() === "true") submitTrueFalse(trueFalse);
                document.getElementById("mark-test").textContent = mark + "/" + numberQuestion;
                document.getElementById("mark-test").style.display = "block";
                document.getElementById("submit-test").style.display = "none";
                document.getElementById("countdown").style.display = "none";
                document.getElementById("number-mark").style.display = "block";
                document.getElementById("number-mark").textContent = parseFloat(((mark / numberQuestion) * 10).toFixed(1));
            } else return;
            clearInterval(interval);
            timeLeft = 0;
            // const inputs = document.getElementsByTagName("input");
            // for (let i = 0; i < inputs.length; i++) {
            //     inputs[i].disabled = true; // Khóa tất cả các ô nhập
            // }
        });
        function submit() {
            mark = 0;
            if (testStructure.multipleChoice.toString() === "true") submitMultipleChoice(multipleChoice);
            if (testStructure.fillWord.toString() === "true") submitFillWord(fillWord);
            if (testStructure.trueFalse.toString() === "true") submitTrueFalse(trueFalse);
            document.getElementById("mark-test").textContent = mark + "/" + numberQuestion;
            document.getElementById("mark-test").style.display = "block";
            document.getElementById("submit-test").style.display = "none";
            document.getElementById("countdown").style.display = "none";
            document.getElementById("number-mark").style.display = "block";
            document.getElementById("number-mark").textContent = parseFloat(((mark / numberQuestion) * 10).toFixed(1));
        }

        function multipleChoiceQuestion(flashcards, n) {
            if (n > flashcards.length) {
                console.error("Số lượng câu hỏi yêu cầu lớn hơn số câu có trong CSDL!");
                return [];
            }
            // shuffled: xáo trộn
            const shuffled = flashcards.sort(() => Math.random() - 0.5);
            const selectedQuestions = shuffled.slice(0, n);

            return selectedQuestions.map((item) => {
                const correctAnswer = item.answer;

                const incorrectAnswers = flashcards
                    .filter((fc) => fc.answer !== correctAnswer)
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 3)
                    .map((fc) => fc.answer);

                const allAnswers = [correctAnswer, ...incorrectAnswers].sort(() => Math.random() - 0.5);

                return {
                    question: item.question,
                    options: allAnswers,
                    correctAnswer: correctAnswer
                };
            });
        }
        function fillWordQuestion(flashcards, n, temporary) {
            if (n > flashcards.length) {
                console.error("Số lượng câu hỏi yêu cầu lớn hơn số câu có trong CSDL!");
                return [];
            }
            // shuffled: xáo trộn
            const shuffled = flashcards.sort(() => Math.random() - 0.5);
            const selectedQuestions = shuffled.slice(0, n);

            if (temporary === "answer") {
                return selectedQuestions.map((item) => {
                    return { question: item.question, correctAnswer: item.answer };
                });
            } else {
                return selectedQuestions.map((item) => {
                    return { question: item.answer, correctAnswer: item.question };
                });
            }
        }
        function trueFalseQuestion(flashcards, n) {
            if (n > flashcards.length) {
                console.warn("Số lượng câu hỏi yêu cầu lớn hơn số câu có trong CSDL! Sẽ sử dụng tối đa số câu hiện có.");
                return[];
                // n = flashcards.length;
            }

            const shuffled = [...flashcards].sort(() => Math.random() - 0.5);
            const selectedQuestions = shuffled.slice(0, n);

            return selectedQuestions.map((item) => {
                const isCorrect = Math.random() > 0.5;
                return {
                    question: item.question,
                    answer: isCorrect ? item.answer : generateFalseAnswer(flashcards, item.answer),
                    isCorrect: isCorrect
                };
            });

            // Hàm phụ: Tạo câu trả lời sai
            function generateFalseAnswer(flashcards, correctAnswer) {
                const incorrectAnswers = flashcards
                    .map(fc => fc.answer)
                    .filter(answer => answer !== correctAnswer);

                return incorrectAnswers.length > 0
                    ? incorrectAnswers[Math.floor(Math.random() * incorrectAnswers.length)]
                    : "Không có câu trả lời sai!";
            }
        }
        function exportMultipleChoiceQuestion(questionData) {
            const multipleChoice = document.getElementById("multiple-choice-format");
            // const choice = document.getElementById("choice-multiple-choice-format");
            var div = document.createElement("div");
            var divChoice = document.createElement("div");
            for (let i = 0; i < questionData.length; i++) {
                div = document.createElement("div");
                div.textContent = questionData[i].question;
                div.classList = "question-multiple-choice-format";
                div.id = `${i}question-multiple-choice`;
                multipleChoice.appendChild(div);

                divChoice = document.createElement("div");
                divChoice.innerHTML = `
                    <form>
                        <input type="radio" name="${i}multiple-choice" id="${i}choice1">
                        <label for="${i}choice1">${questionData[i].options[0]}</label>
                        <input type="radio" name="${i}multiple-choice" id="${i}choice2">
                        <label for="${i}choice2">${questionData[i].options[1]}</label>
                        <input type="radio" name="${i}multiple-choice" id="${i}choice3">
                        <label for="${i}choice3">${questionData[i].options[2]}</label>
                        <input type="radio" name="${i}multiple-choice" id="${i}choice4">
                        <label for="${i}choice4">${questionData[i].options[3]}</label>
                    </form>
                `;
                multipleChoice.appendChild(divChoice);
            }
        }
        function exportFillWordQuestion(questionData) {
            var fillWord = document.getElementById("fill-word-format");
            var div = document.createElement("div");
            var divChoice = document.createElement("div");
            for (let i = 0; i < questionData.length; i++) {
                div = document.createElement("div");
                div.textContent = questionData[i].question;
                div.classList = "question-fill-word-format";
                div.id = `${i}question-fill-word`;
                fillWord.appendChild(div);

                divChoice = document.createElement("div");
                divChoice.innerHTML = `
                    <input type="text" id="" name="${i}fill-word" maxlength="${questionData[i].correctAnswer.length}">
                    <div class="answer-fill-world" id="${i}fill-word" style="margin-bottom: 10px; display:none">${questionData[i].correctAnswer}</div>
                `;
                fillWord.appendChild(divChoice);
            }
        }
        function exportTrueFalseQuestion(questionData) {
            var trueFalse = document.getElementById("true-false-format");
            var div = document.createElement("div");
            var divChoice = document.createElement("div");
            for (let i = 0; i < questionData.length; i++) {
                div = document.createElement("div");
                div.textContent = questionData[i].question + " - " + questionData[i].answer;
                div.classList = "question-true-false-format";
                div.id = `${i}question-true-false`;
                trueFalse.appendChild(div);

                divChoice = document.createElement("div");
                divChoice.innerHTML = `
                <form>
                    <input type="radio" name="${i}question-true-false" id="${i}select-true">
                    <label for="${i}select-true">true</label>
                    <input type="radio" name="${i}question-true-false" id="${i}select-false">
                    <label for="${i}select-false">false</label>
                </form>
                    
                `;
                trueFalse.appendChild(divChoice);
            }
        }
        function submitMultipleChoice(questionData) {
            for (let i = 0; i < questionData.length; i++) {
                const selectedOption = document.querySelectorAll(`input[name="${i}multiple-choice"]`);
                const checkedOption = document.querySelector(`input[name="${i}multiple-choice"]:checked`);
                if (checkedOption) { // Kiểm tra nếu có lựa chọn được chọn
                    const labelCheckedOption = document.querySelector(`label[for="${checkedOption.id}"]`);
                    if (labelCheckedOption && labelCheckedOption.textContent.trim() !== questionData[i].correctAnswer) {
                        labelCheckedOption.style.backgroundColor = "rgba(255, 0, 0, 0.2)"; // Đổi màu nền đáp án đúng
                        const element = document.getElementById(`${i}question-multiple-choice`);
                        element.innerHTML += `<img src="image/cancel.png" style="width: 20px; vertical-align: middle; margin-bottom: 10px; margin-left: 10px;" alt="">`;
                    } else if (labelCheckedOption) {
                        mark++;
                        const element = document.getElementById(`${i}question-multiple-choice`);
                        element.innerHTML += `<img src="image/check.png" style="width: 20px; vertical-align: middle; margin-bottom: 10px; margin-left: 10px;" alt="">`;
                    }
                } else {
                    const element = document.getElementById(`${i}question-multiple-choice`);
                    element.innerHTML += `<img src="image/cancel.png" style="width: 20px; vertical-align: middle; margin-bottom: 10px; margin-left: 10px;" alt="">`;
                }

                // console.log(selectedOption);
                for (let j = 0; j < selectedOption.length; j++) {
                    if (selectedOption[j]) {
                        const label = document.querySelector(`label[for="${selectedOption[j].id}"]`);
                        // alert(label.textContent+"-"+questionData[i].correctAnswer);
                        if (label && label.textContent === questionData[i].correctAnswer) {
                            label.style.backgroundColor = "rgba(0, 255, 0, 0.2)";
                        }
                    }
                    selectedOption[j].disabled = true;
                }

            }
        }
        function submitTrueFalse(questionData) {
            for (let i = 0; i < questionData.length; i++) {
                const selectedOption = document.querySelectorAll(`input[name="${i}question-true-false"]`);

                const checkedOption = document.querySelector(`input[name="${i}question-true-false"]:checked`);
                if (checkedOption) { // Kiểm tra nếu có lựa chọn được chọn
                    const labelCheckedOption = document.querySelector(`label[for="${checkedOption.id}"]`);
                    if (labelCheckedOption && labelCheckedOption.textContent.trim() !== questionData[i].isCorrect.toString()) {
                        labelCheckedOption.style.backgroundColor = "rgba(255, 0, 0, 0.2)"; // Đổi màu nền đáp án đúng
                        const element = document.getElementById(`${i}question-true-false`);
                        element.innerHTML += `<img src="image/cancel.png" style="width: 20px; vertical-align: middle; margin-bottom: 10px; margin-left: 10px;" alt="">`;
                    } else if (labelCheckedOption) {
                        mark++;
                        const element = document.getElementById(`${i}question-true-false`);
                        element.innerHTML += `<img src="image/check.png" style="width: 20px; vertical-align: middle; margin-bottom: 10px; margin-left: 10px;" alt="">`;
                    }
                } else {
                    const element = document.getElementById(`${i}question-true-false`);
                    element.innerHTML += `<img src="image/cancel.png" style="width: 20px; vertical-align: middle; margin-bottom: 10px; margin-left: 10px;" alt="">`;
                }
                // console.log(selectedOption);
                for (let j = 0; j < selectedOption.length; j++) {
                    if (selectedOption[j]) {
                        const label = document.querySelector(`label[for="${selectedOption[j].id}"]`);
                        // alert("."+label.textContent+"."+"-"+"."+questionData[i].isCorrect+".");
                        // alert(label.textContent == questionData[i].isCorrect.toString());
                        if (label && label.textContent === questionData[i].isCorrect.toString()) {
                            label.style.backgroundColor = "rgba(0, 255, 0, 0.2)";
                        }
                    }
                    selectedOption[j].disabled = true;
                }

            }
        }
        function submitFillWord(questionData) {
            for (let i = 0; i < questionData.length; i++) {
                const selectedOption = document.querySelector(`input[name="${i}fill-word"]`);

                if (selectedOption) {
                        const yourAnswer = selectedOption.value.trim();
                        const correct = questionData[i].correctAnswer.split(",").map(a => a.trim());
                        const yourAnswerList = yourAnswer.split(",").map(a => a.trim());
                        const isRight = yourAnswerList.every(ans => correct.includes(ans));

                    if (isRight) {
                        mark++;
                        selectedOption.style.backgroundColor = "rgba(0, 255, 0, 0.2)";
                        const element = document.getElementById(`${i}question-fill-word`);
                        element.innerHTML += `<img src="image/check.png" style="width: 20px; vertical-align: middle; margin-bottom: 10px; margin-left: 10px;" alt="">`;
                    }
                    else {
                        selectedOption.style.backgroundColor = "rgba(255, 0, 0, 0.1)";
                        document.getElementById(`${i}fill-word`).style.display = "block";
                        const element = document.getElementById(`${i}question-fill-word`);
                        element.innerHTML += `<img src="image/cancel.png" style="width: 20px; vertical-align: middle; margin-bottom: 10px; margin-left: 10px;" alt="">`;
                    }
                }
                selectedOption.disabled = true;

            }
        }
        // window.addEventListener("beforeunload", (event) => {
        //     event.preventDefault(); // Ngăn hành vi mặc định
        //     event.returnValue = ""; // Yêu cầu trình duyệt hiển thị hộp thoại cảnh báo
        //     console.log("Người dùng cố gắng reload!");
        // });

        document.addEventListener("keydown", (event) => {
            if (event.key === "F5" || (event.ctrlKey && event.key === "r")) {
                event.preventDefault();
                console.log("Người dùng nhấn phím reload!");
            }
        });
        localStorage.removeItem("test-structure");


    </script>
</body>

</html>